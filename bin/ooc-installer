#!/usr/bin/env bash

set -e
[ -n "$OOC_DEBUG" ] && set -x

if ! command -v wget 1>/dev/null 2>&1; then
  echo "odoo-one-click: wget is not installed, can't continue." >&2
  exit 1
fi

if ! command -v jq 1>/dev/null 2>&1; then
  echo "odoo-one-click: jq is not installed, can't continue." >&2
  exit 1
fi

if ! command -v unzip 1>/dev/null 2>&1; then
  echo "odoo-one-click: unzip is not installed, can't continue." >&2
  exit 1
fi

release_info=$(curl -s "https://api.github.com/repos/rockavoldy/odoo-one-click/releases/latest")

tag_name=$(echo "$release_info" | jq -r '.tag_name')
#tag_name="amd64"
asset_url=$(echo "$release_info" | jq -r --arg tag_name "$tag_name" '.assets[] | select(.name | contains($tag_name)) | .browser_download_url')
asset_name=$(echo "$release_info" | jq -r --arg tag_name "$tag_name" '.assets[] | select(.name | contains($tag_name)) | .name')

if ! $asset_name 1>/dev/null 2>&1; then
  echo "odoo-one-click: no release detected, please create issues" >&2
  exit 1
fi

wget "$asset_url" -O "$asset_name"

unzip "$asset_name" -d /tmp/
sudo su
mv /tmp/odoo-one-click /usr/local/bin/odoo-one-click
chmod +x /usr/local/bin/odoo-one-click